<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è²·ã„ç‰©ãƒªã‚¹ãƒˆ</title>
</head>
<body>
    <h1>è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h1>
    <table>
        <thead>
            <tr>
                <th>ã‚¢ã‚¤ãƒ†ãƒ å (ç¾ï¼šåœ¨åº«æ•°)</th>
                <th>è³¼å…¥æ•°</th>
                <th>å‰Šé™¤</th>
                <th>è³¼å…¥æ¸ˆã¿</th>
                <th>è³¼å…¥æ—¥</th>
            </tr>
        </thead>
        <tbody>
            {% for shopping_item in shopping_items %}
            <tr>
                <td>{{ shopping_item.item.name }} (ç¾ï¼š{{ shopping_item.item.stock_quantity }}å€‹)</td>
                <td>
                    <button class="decrement" data-id="{{ shopping_item.id }}">-</button>
                    <span class="quantity">{{ shopping_item.quantity_to_buy }}</span>
                    <button class="increment" data-id="{{ shopping_item.id }}">+</button>
                </td>
                <td>
                    <button class="delete" data-id="{{ shopping_item.id }}">ğŸ—‘ï¸</button>
                </td>
                <td>
                    <input type="checkbox" class="mark-purchased" data-id="{{ shopping_item.id }}">
                </td>
                <td>
                    <input type="date" class="purchased-date" data-id="{{ shopping_item.id }}">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // æ•°é‡å¢—æ¸›
    document.querySelectorAll('.increment, .decrement').forEach(button => {
        button.addEventListener('click', function () {
            const action = this.classList.contains('increment') ? 'increment' : 'decrement';
            const shoppingListId = this.dataset.id;

            fetch(`/shopping_list/update_quantity/${shoppingListId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.quantity_to_buy !== undefined) {
                    this.parentElement.querySelector('.quantity').textContent = data.quantity_to_buy;
                }
            });
        });
    });

    // å‰Šé™¤
    document.querySelectorAll('.delete').forEach(button => {
        button.addEventListener('click', function () {
            const shoppingListId = this.dataset.id;

            fetch(`/shopping_list/delete/${shoppingListId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.closest('tr').remove();
                }
            });
        });
    });

    // è³¼å…¥æ¸ˆã¿
    document.querySelectorAll('.mark-purchased').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const shoppingListId = this.dataset.id;
            const purchasedDate = this.closest('tr').querySelector('.purchased-date').value;

            if (!purchasedDate) {
                alert("è³¼å…¥æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                this.checked = false;
                return;
            }

            fetch(`/shopping_list/mark_as_purchased/${shoppingListId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ purchased_date: purchasedDate }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.closest('tr').remove();
                } else {
                    alert(data.error || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                }
            });
        });
    });
});
</script>
</html>
