<!DOCTYPE html>
<html lang="ja">
{% extends "base.html" %}
{% block head %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アイテム編集</title>
</head>
{% endblock head %}

<body>
    {% block content %}
        <div class="container mt-5">
            <h1>アイテム編集</h1>
            <form method="post">
                {% csrf_token %}
                {% if error_messages %}
                    <div class="error-container">
                        <ul>
                            {% for error in error_messages %}
                                <li class="error">{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                <!-- アイテム情報 -->
                <section class="item-info">
                    <h2>アイテム詳細</h2>
                    <div class="form-group">
                        {{ item_form.name.label_tag }}
                        {{ item_form.name }}
                    </div>
                    <div class="form-group">
                        {{ item_form.category.label_tag }}
                        {{ item_form.category }}
                    </div>
                    <div class="form-group">
                        {{ item_form.stock_quantity.label_tag }}
                        {{ item_form.stock_quantity }}
                    </div>
                    <div class="form-group">
                        {{ item_form.stock_min_threshold.label_tag }}
                        <div class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-text">
                                {{ item_form.stock_min_threshold.help_text }}
                            </div>
                        </div>
                        {{ item_form.stock_min_threshold }}
                    </div>
                    <div class="form-group">
                        {{ item_form.memo.label_tag }}
                        {{ item_form.memo }}
                    </div>
                    <div class="form-group">
                        {{ item_form.last_purchase_date.label_tag }}
                        {{ item_form.last_purchase_date }}
                    </div>
                    <div class="form-group">
                        <label for="{{ item_form.reminder.id_for_label }}">{{ item_form.reminder.label }}</label>
                        <div class="reminder-checkbox-container">
                            {{ item_form.reminder }}
                            <span class="reminder-status">ON</span>
                        </div>
                    </div>
                </section>

                
                <!-- 店舗情報 -->
                <section class="store-info">
                    <h2>店舗ごとのアイテム価格登録</h2>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>店舗名</th>
                                <th>価格</th>
                                <th>入数</th>
                                <th>メモ</th>
                                <th>価格不明</th>
                                <th>取り扱いなし</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for store_form in store_forms %}
                            <tr>
                                <!-- 店舗名を表示 -->
                                <td>{{ store_form.instance.store.name }}</td>
                                
                                <!-- 入力フィールド -->
                                <td>
                                    <input type="number" 
                                           name="{{ store_form.prefix }}-price" 
                                           value="{{ store_form.price.value }}">
                                </td>
                                <td>
                                    <input type="number" 
                                           name="{{ store_form.prefix }}-price_per_unit" 
                                           value="{{ store_form.price_per_unit.value }}">
                                </td>
                                <td>
                                    <input type="text" 
                                           name="{{ store_form.prefix }}-memo" 
                                           value="{{ store_form.memo.value }}">
                                </td>
                                <td>
                                    <input type="checkbox" 
                                           name="{{ store_form.prefix }}-price_unknown" 
                                           {% if store_form.price_unknown.value %}checked{% endif %}>
                                    価格不明
                                </td>
                                <td>
                                    <input type="checkbox" 
                                           name="{{ store_form.prefix }}-no_handling" 
                                           {% if store_form.no_handling.value %}checked{% endif %}>
                                    取り扱いなし
                                </td>
                                
                            </tr>
                            <!-- 隠しフィールド -->
                            {{ store_form.store.as_hidden }}
                            {% endfor %}
                        </tbody>
                    </table>
                </section>

                <!-- 保存ボタン -->
                <div class="form-actions mt-4">
                    <button type="submit" class="btn btn-primary">保存</button><br>
                    <button type="button" id="delete-button" class="btn btn-danger">削除</button>
                    <a href="{% url 'item_list' %}" class="btn btn-secondary">一覧に戻る</a>
                </div>
            </form>
        </div>
        
        <script>
            document.getElementById("delete-button").addEventListener("click", function() {
                if (!confirm("本当に削除しますか？")) {
                    return;
                }
            
                fetch("{% url 'item_delete' item.id %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}", // CSRFトークンを送信
                        "Content-Type": "application/json"
                    },
                    credentials: "same-origin"
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("アイテムが削除されました。");
                        window.location.href = "{% url 'item_list' %}"; // アイテム一覧へリダイレクト
                    } else {
                        alert("削除に失敗しました: " + data.message);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("エラーが発生しました。");
                });
            });
            
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('tbody tr').forEach(row => {
                    const priceField = row.querySelector('input[name$="-price"]');
                    const priceUnknownCheckbox = row.querySelector('input[name$="-price_unknown"]');
                    const noPriceCheckbox = row.querySelector('input[name$="-no_handling"]');
        
                    priceUnknownCheckbox.addEventListener('change', () => {
                        if (priceUnknownCheckbox.checked) {
                            noPriceCheckbox.checked = false;
                            priceField.value = "";  // 価格をリセット
                        }
                    });
        
                    noPriceCheckbox.addEventListener('change', () => {
                        if (noPriceCheckbox.checked) {
                            priceUnknownCheckbox.checked = false;
                            priceField.value = "";  // 価格をリセット
                        }
                    });
                });
            });
        </script>
    {% endblock %}
</body>
</html>