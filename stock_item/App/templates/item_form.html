{% comment %} <!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>アイテム編集</title>
</head>
<body>
    <h1>アイテム編集画面</h1>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
    
        <h2>店舗ごとの価格設定</h2>
        <table>
            <thead>
                <tr>
                    <th>店舗</th>
                    <th>価格</th>
                    <th>入数</th>
                    <th>単価</th>
                    <th>メモ</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in stores_with_forms %}
                    <tr>
                        <td>{{ entry.store.name }}</td>
                        <td>
                            <input type="number" name="price_{{ forloop.counter }}" value="{{ entry.form.instance.price }}" data-index="{{ forloop.counter }}" step="0.01">
                        </td>
                        <td>
                            <input type="number" name="unit_quantity_{{ forloop.counter }}" value="{{ entry.form.instance.unit_quantity }}" data-index="{{ forloop.counter }}" step="1">
                        </td>
                        <td>
                            <span data-index="{{ forloop.counter }}">
                                {% if entry.unit_price %}
                                    {{ entry.unit_price|floatformat:2 }}円
                                {% else %}
                                    計算不可
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <input type="text" name="memo_{{ forloop.counter }}" value="{{ entry.form.instance.memo }}">
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <button type="submit">保存</button>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const priceInputs = document.querySelectorAll('input[name^="price_"]');
            const quantityInputs = document.querySelectorAll('input[name^="unit_quantity_"]');
            
            priceInputs.forEach((priceInput, index) => {
                priceInput.addEventListener('input', function() {
                    calculateUnitPrice(index);
                });
            });

            quantityInputs.forEach((quantityInput, index) => {
                quantityInput.addEventListener('input', function() {
                    calculateUnitPrice(index);
                });
            });

            function calculateUnitPrice(index) {
                const price = parseFloat(priceInputs[index].value);
                const quantity = parseInt(quantityInputs[index].value, 10);
                const unitPriceCell = document.querySelector('span[data-index="'+(index+1)+'"]');

                if (!isNaN(price) && !isNaN(quantity) && quantity !== 0) {
                    const unitPrice = (price / quantity).toFixed(2);
                    unitPriceCell.innerText = `${unitPrice}円`;
                } else {
                    unitPriceCell.innerText = '計算不可';
                }
            }
        });
    </script>
</body>
</html> {% endcomment %}
